<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>On Call Hero - A Game About PagerDuty</title>
	<script type="text/javascript" src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">


var game = new Phaser.Game(800, 640, Phaser.AUTO, '', { preload: preload,
                                                        create: create,
                                                        update: update,
                                                        render: render
                                                      });


// stage
var map;
var layer;
var readyScreenBitmap;
var readyScreenLevelName;
var readyScreenHelpText;
var cursors;

// sprites
var hero;
var pager;
var spikes;
var scoreText;

// game state
var score = 0;
var stop = false;
var pointsRemaining;
var levels = Array(
  //"levels/2.json"
  "levels/1.json", "levels/2.json"
);
var onReadyScreen = false;

var currentLevel = 0;

// level
var seconds;
var possiblePoints;
var levelBegin;


function preload() {
  game.stage.backgroundColor = "#7ec0ee";
  for(var i = 0; i < levels.length; i++){
    game.load.tilemap("level" + i, levels[i], null, Phaser.Tilemap.TILED_JSON);
  }
  game.load.image("ground_1x1", "assets/Ground.png");
  game.load.image("hero", "assets/Hero.png");
  game.load.image("spike", "assets/Spike.png");
  game.load.spritesheet("pager", "assets/Pager.png", 32, 32);
}

function loadLevel(resourceName){
  map = game.add.tilemap(resourceName);
  map.addTilesetImage('Ground', 'ground_1x1');
  if(layer){ layer.destroy(); }
  layer = map.createLayer("Ground");
  map.setCollisionByExclusion([], true, layer);

  // find hero/pager
  var heroX = map.objects.Hero[0].x;
  var heroY = map.objects.Hero[0].y;

  var pagerX = map.objects.Pager[0].x;
  var pagerY = map.objects.Pager[0].y;

  // position hero
  hero.x = heroX;
  hero.y = heroY - hero.height;

  // position pager
  pager.revive();
  pager.x = pagerX
  pager.y = pagerY - pager.height;

  if(spikes){ spikes.destroy(); } // kill spikes before setting up level

  if(map.objects.Spikes){
    spikes = game.add.group();
    map.objects.Spikes.map(
      function(spike){
        var s = game.add.sprite(spike.x, spike.y, "spike");
        s.body.collideWorldBounds = true;
        spikes.add(s);
      }
    );
  }
  // level parameters
  possiblePoints = parseInt(map.properties.possiblePoints);
  seconds = parseInt(map.properties.seconds);
  pointsRemaining = possiblePoints;

  readyScreen();
}

function readyScreen(){
  stop = true;
  onReadyScreen = true;
  readyScreenBitmap = game.add.graphics(0, 0);
  readyScreenBitmap.beginFill(0);
  readyScreenBitmap.drawRect(0, 0, 900, 800);
  readyScreenLevelName = game.add.text(16, 16, 'Level ' + (currentLevel + 1), { font: '32px arial', fill: '#FFFFFF'});
  var text = map.properties.text || "";
  readyScreenHelpText = game.add.text(16, 64, text + "\n\nPress Space to Begin", {font: '12px arial', fill: '#FFFFFF'});
}

function beginLevel(){
  readyScreenHelpText.destroy();
  readyScreenLevelName.destroy();
  readyScreenBitmap.destroy();
  stop = false;
  onReadyScreen = false;
  levelBegin = game.time.now;
}

function create(){

  // configure hero
  hero = game.add.sprite(-1000, -1000, "hero");
  hero.body.bounce.y = 0.2;
  hero.body.collideWorldBounds = true;

  // configure pager
  pager = game.add.sprite(1000, 1000, "pager");
  pager.body.bounce.y = 0.5;
  pager.animations.add('paging', [0,1,2], 10, true);
  pager.animations.play('paging');

  game.physics.gravity.y = 300;
  cursors = game.input.keyboard.createCursorKeys();

  scoreText = game.add.text(16, 16, 'score: 0', { font: '32px arial', fill: '#313131'});

  loadLevel("level0");
}

function update() {
  game.physics.collide(layer, hero);
  game.physics.collide(layer, pager);
  game.physics.collide(spikes, layer);
  game.physics.overlap(hero, spikes, lose);
  game.physics.overlap(hero, pager, win);

  hero.body.velocity.x = 0;
  if(onReadyScreen && stop){
    if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)){
      beginLevel();
    }
  }
  else if(!stop){
    if (cursors.left.isDown){
      hero.body.velocity.x = -150;
    }
    else if (cursors.right.isDown){
      hero.body.velocity.x = 150;
    }
    if(cursors.up.isDown && hero.body.onFloor() && !hero.body.onWall()){
      hero.body.velocity.y = 1200;
    }

    var millisSince = game.time.elapsedSince(levelBegin);
    pointsRemaining = Math.floor(possiblePoints * (((seconds * 1000) - millisSince)/(seconds * 1000)));
    if(pointsRemaining <= 0){
      lose();
    }
    scoreText.content = "Remaining: " + ((pointsRemaining > 0) ? pointsRemaining : 0);
  }
}

var rect = new Phaser.Rectangle( 100, 100, 100, 100 ) ;
function render() {
  game.debug.renderRectangle(rect, 'rgba(255,0,0,1)');
}

function win(){
  score += pointsRemaining;
  pager.kill();

  currentLevel += 1;
  if(currentLevel >= levels.length){
    alert("OUT OF LEVELS, YOUR SCORE WAS " + score);
    stop = true;
  }
  else{
    loadLevel("level" + currentLevel);
  }
}

function lose(){
  stop = true;
  hero.kill();
  alert("LOSE, YOUR SCORE WAS " + score);
}


</script>

</body>
</html>